<?

require($_SERVER["DOCUMENT_ROOT"]."/bitrix/header.php");
$APPLICATION->SetPageProperty("keywords", "адреса магазинов, ювелирных салонов, сеть 585, gold, ювелирный магазин, ювелирная сеть, официальный сайт");
$APPLICATION->SetPageProperty("description", "Адреса магазинов. О компании. Сеть ювелирных магазинов 585 Gold.");
$APPLICATION->SetPageProperty("title", "Адреса ювелирных магазинов | О ювелирной сети | Ювелирный магазин 585 Gold");
?>
<section class="content">
<?
/* function getNewFormText($text, $numForm){
    $urlXml = "http://export.yandex.ru/inflect.xml?name=".urlencode($text);
    $result = @simplexml_load_file($urlXml);
    if($result){
        $arrData = array();
        foreach ($result->inflection as $one) {
            $arrData[] = (string) $one;
        }
        return $arrData[$numForm];
    }
    return false;
}*/
function rus2translit($string) {
    $converter = array(
        'а' => 'a',   'б' => 'b',   'в' => 'v',
        'г' => 'g',   'д' => 'd',   'е' => 'e',
        'ё' => 'e',   'ж' => 'zh',  'з' => 'z',
        'и' => 'i',   'й' => 'y',   'к' => 'k',
        'л' => 'l',   'м' => 'm',   'н' => 'n',
        'о' => 'o',   'п' => 'p',   'р' => 'r',
        'с' => 's',   'т' => 't',   'у' => 'u',
        'ф' => 'f',   'х' => 'h',   'ц' => 'c',
        'ч' => 'ch',  'ш' => 'sh',  'щ' => 'sch',
        'ь' => '\'',  'ы' => 'y',   'ъ' => '\'',
        'э' => 'e',   'ю' => 'yu',  'я' => 'ya',

        'А' => 'A',   'Б' => 'B',   'В' => 'V',
        'Г' => 'G',   'Д' => 'D',   'Е' => 'E',
        'Ё' => 'E',   'Ж' => 'Zh',  'З' => 'Z',
        'И' => 'I',   'Й' => 'Y',   'К' => 'K',
        'Л' => 'L',   'М' => 'M',   'Н' => 'N',
        'О' => 'O',   'П' => 'P',   'Р' => 'R',
        'С' => 'S',   'Т' => 'T',   'У' => 'U',
        'Ф' => 'F',   'Х' => 'H',   'Ц' => 'C',
        'Ч' => 'Ch',  'Ш' => 'Sh',  'Щ' => 'Sch',
        'Ь' => '\'',  'Ы' => 'Y',   'Ъ' => '\'',
        'Э' => 'E',   'Ю' => 'Yu',  'Я' => 'Ya',
    );
    return strtr($string, $converter);
}
function str2url($str) {
    // переводим в транслит
    $str = rus2translit($str);
    // в нижний регистр
    $str = strtolower($str);
    // заменям все ненужное нам на "-"
    $str = preg_replace('~[^-a-z0-9_]+~u', '-', $str);
    // удаляем начальные и конечные '-'
    $str = trim($str, "-");
    return $str;
}
// $obCache = new CPHPCache();
// $cacheLifetime_adress = 86400; $cacheID_adress = 'listCity_adress'; $cachePath_adress = '/'.$cacheID_adress;
// if( $obCache->InitCache($cacheLifetime_adress, $cacheID_adress, $cachePath_adress))
// {
// 	$vars_city_adress = $obCache->GetVars();
// 	$arProps = $vars_city_adress['listCity_adress'];
// }
// elseif( $obCache->StartDataCache())
// {
// 	if (CModule::IncludeModule("iblock")):
// 	$j = 0;
// 	$arSelect = Array("ID","CODE", "PREVIEW_TEXT", "IBLOCK_ID", "NAME","PROPERTY_*");//IBLOCK_ID и ID обязательно должны быть указаны, см. описание arSelectFields выше
// 	$arFilter = Array("IBLOCK_ID"=>13, "ACTIVE_DATE"=>"Y", "ACTIVE"=>"Y");
// 	$res = CIBlockElement::GetList(Array(), $arFilter, false, false, $arSelect);

// 	while($ob = $res->GetNextElement()){
// 		$arFields[$j] = $ob->GetFields();
// 		$arProps[$j] = $ob->GetProperties();
// 		$arProps[$j]['coords123'] = $arFields[$j]['NAME'];
// 		$j++;
// 	}
// 	endif;
// 	$obCache->EndDataCache(array('listCity_adress' => $arProps));
// };
// foreach ($arProps as $key => $value) {
// 	if(!isset($arCity[$value['city']['VALUE']]))
// 	$arCity[$value['city']['VALUE']] = $value;

// 	$arShop[$key]['coords'] = $value['coords123'];
// 	$arShop[$key]['address'] = $value['adress']['VALUE'];
// 	$arShop[$key]['params'] = $value;
// 	}

// ksort($arCity);
// 
$arCityTmp = Zoloto585Store::getCities();
$arShop = Zoloto585Store::getStores();

/** Получим для каждого города координаты первого попавшегося магазина в нем */
$arCity = [];
foreach ($arShop as $shop) {
	$cityName = $shop['UF_CITY'];
	if (!isset($arCity[$cityName])) {
		$arCity[$cityName] = $shop;
	}
}
?>
<script>
	jQuery(document).ready(function ($) {
		"use strict";
		$('#region_id').change(function(){
            $('#region_id option').show();
            $('#region_id option:selected').hide();
			var city = $('#region_id option:selected').text();
			var href = $('#region_id option:selected').attr('data-href');
			var name = $('#region_id option:selected').data('name');
			if(document.location.href=='/about/address/' && href!='') {
				history.replaceState(null, '', '/about/address/' + href + '/');
			};
            $('h1').text('Ювелирные магазины в городе '+name);
			var coords = $('#region_id option:selected').attr('value').split(',');
			$('#header #choose-city a').text(city);
			$.cookie("city", city, { expires : 365, path: '/'});
			$.cookie("first_coord", +coords[0], { expires : 365, path: '/' });
			$.cookie("second_coord", +coords[1], { expires : 365, path: '/' });
			$.ajax({
				url: "/about/address/city_ajax.php",
				data: {city: city},
				type: "post",
				success: function(html) {
					$('.list').html(html);
				}
			});
		});
	});
</script>
<div class="wrp clearfix">
<h1>Адреса магазинов в других городах</h1>
	<article class="shops clearfix">
			<div class="maps">
				<script src="http://api-maps.yandex.ru/2.0/?load=package.full&lang=ru-RU" type="text/javascript"></script>
				<script type="text/javascript">
					var myMap;
					ymaps.ready(init); // Ожидание загрузки API с сервера Яндекса
					function init () {
						var city = $.cookie("city");
						if (city){
                			$('#region_id option:contains("'+city+'")').attr('selected', 'selected');
                			var coords = $('#region_id option:selected').attr('value').split(',');
							myMap = new ymaps.Map("map", {
								center: coords, // Координаты центра карты
								zoom: 11 // Zoom
							});
						}else{
						    var geolocation = ymaps.geolocation,
	        				coords = [geolocation.latitude, geolocation.longitude],
							myMap = new ymaps.Map("map", {
								center: coords, // Координаты центра карты
								zoom: 11 // Zoom
							});
						}
						$.cookie('first_coord', coords[0], { expires: 365, path: '/' });
						$.cookie('second_coord', coords[1], { expires: 365, path: '/' });

						$('#region_id').bind('change', function(){
							var option = $('#region_id option:selected'), coords = option.attr('value').split(',');
							myMap.panTo([+coords[0],+coords[1]], {flying: true});
							$.cookie('first_coord', coords[0], { expires: 365, path: '/' });
							$.cookie('second_coord', coords[1], { expires: 365, path: '/' });
							
							var city = option.html();
							$.cookie('city', city, { expires: 365, path: '/' });
							//alert(city);
							$('h1').text('Адреса магазинов в городе '+city);
							$.ajax({
								url: "/about/address/city_ajax.php",
								data: {city: city},
								type: "post",
								success: function(html) {
									$('.list').html(html);
								}
							});
							$('select.select_city option:contains("'+city+'")').attr('selected', 'selected');
		                    $('.opt:contains("'+city+'")').addClass('selected sel');
		                    $('#choose-city a span, .jq-selectbox__select-text').text(city);
		                    
							set_city();
						});
						$('#region_id').trigger('change');
						
						$('#select_city').click(function(){
							var data = $('.opt:selected').html();
							var elems=$("#region_id .opt");
							//var tmp="";
							for(var i=0;i<elems.size();i++){
								var elem = elems.eq(i);
								var text = elem.html();
								if(text==data){
									$("#region_id").val(elem.val());
									$("#region_id").change();
									break;
								}
							}
						});
						
						myMap.controls.add(
				            new ymaps.control.ZoomControl()
				        );
				        houseCollection = new ymaps.GeoObjectCollection();
				        <?php
						foreach ($arShop as $key => $property) {				        	
							?>
	                        metroGeoObject = new ymaps.Placemark([<?=$property['GPS_N']?>,<?=$property['GPS_S']?>], {
				                hintContent: "<?=str_replace('"', '\"', $property['ADDRESS']);?>",
				                balloonContent: '',
                                url: '/about/address/<?=str2url($property['UF_CITY'])?>/<?=str2url($property['ADDRESS'])?>/'
                            }, {
				                iconLayout: 'default#image',
				                iconImageHref: '/about/address/pointer.png', // картинка иконки
				                iconImageSize: [43, 62], // размеры картинки
				                iconImageOffset: [-3, -62]
				            });
				            houseCollection.add(metroGeoObject);
						<?}?>
						myMap.geoObjects.add(houseCollection);
                        myMap.geoObjects.events.add('click', function (e) {
                            window.location.href = e.get('target').properties.get('url');
                        });
					}
				</script>
				<div id="map" class="map"></div>
			</div>

			<div class="shop_list">
				<div class="select">
					<select name="region_id" id="region_id" class="">
					<?foreach ($arCity as $key => $cityInfo) { ?>
						<option value="<?=$cityInfo['GPS_N']?>,<?=$cityInfo['GPS_S']?>" class="opt" data-name="<?=$key?>" data-href="<?=str2url($key)?>"><?=$key?></option>
					<?}?>
					</select>
				</div>

				<div id="perfect_scroll" class="perfect-scroll">
					<div class="list">
				
					</div>
				</div>				
			</div>
	</article>
</div>

 </section>
<script type="text/javascript">
function targetis_adress(){
(function(h){function k(){var a=function(d,b){if(this instanceof AdriverCounter)d=a.items.length||1,a.items[d]=this,b.ph=d,b.custom&&(b.custom=a.toQueryString(b.custom,";")),a.request(a.toQueryString(b));else return a.items[d]};a.httplize=function(a){return(/^\/\//.test(a)?location.protocol:"")+a};a.loadScript=function(a){try{var b=g.getElementsByTagName("head")[0],c=g.createElement("script");c.setAttribute("type","text/javascript");c.setAttribute("charset","windows-1251");c.setAttribute("src",a.split("![rnd]").join(Math.round(1E6*Math.random())));c.onreadystatechange=function(){/loaded|complete/.test(this.readyState)&&(c.onload=null,b.removeChild(c))};c.onload=function(){b.removeChild(c)};b.insertBefore(c,b.firstChild)}catch(f){}};a.toQueryString=function(a,b,c){b=b||"&";c=c||"=";var f=[],e;for(e in a)a.hasOwnProperty(e)&&f.push(e+c+escape(a[e]));return f.join(b)};a.request=function(d){var b=a.toQueryString(a.defaults);a.loadScript(a.redirectHost+"/cgi-bin/erle.cgi?"+d+"&rnd=![rnd]"+(b?"&"+b:""))};a.items=[];a.defaults={tail256:document.referrer||"unknown"};a.redirectHost=a.httplize("//ad.adriver.ru");return a}var g=document;"undefined"===typeof AdriverCounter&&(AdriverCounter=k());new AdriverCounter(0,h)})
({"sid":209132,"sz":"address","bt":62,"custom":{"150":"lead_id","153":"user_id"}});
};
targetis_adress();
</script>

 <?

 require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php");?>

